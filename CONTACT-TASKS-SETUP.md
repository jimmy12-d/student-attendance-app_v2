# Contact Tasks Collection Setup Guide

This guide explains how to set up the `contactTasks` Firebase collection for the To-Do page student contact tracking system.

## Collection Structure

### Collection Name: `contactTasks`

### Document Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `studentId` | string | Yes | Reference to the student document ID |
| `studentName` | string | Yes | Full name of the student |
| `class` | string | Yes | Student's class |
| `shift` | string | Yes | Student's shift (morning/afternoon/evening) |
| `taskType` | string | Yes | Type of task: 'consecutive' or 'warning' |
| `reason` | string | Yes | Detailed reason for the contact task |
| `assignedTo` | string | No | Assigned staff member: 'Jimmy', 'Jon', 'Jasper', 'Jason', or empty |
| `status` | string | Yes | Current status: 'unresolved', 'contacted', or 'resolved' |
| `createdAt` | timestamp | Yes | When the task was created |
| `updatedAt` | timestamp | Yes | When the task was last updated |
| `completedAt` | timestamp | No | When the task was marked as resolved |
| `notes` | string | No | Additional notes about the task |
| `consecutiveDays` | number | No | Number of consecutive absence days (for consecutive type) |
| `lastAbsentDate` | string | No | Last date of absence (YYYY-MM-DD format) |
| `autoGenerated` | boolean | No | Whether task was auto-generated by system |

## Firestore Security Rules

Add these rules to your `firestore.rules` file:

```javascript
// Contact Tasks Collection - For tracking student follow-ups
match /contactTasks/{taskId} {
  // Only authenticated admin users can read, write, update, and delete tasks
  allow read, write: if request.auth != null && 
    exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}
```

## Firestore Indexes

Add these composite indexes to `firestore.indexes.json`:

```json
{
  "indexes": [
    {
      "collectionGroup": "contactTasks",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "contactTasks",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "status",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "contactTasks",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "taskType",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "contactTasks",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "assignedTo",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}
```

## Deployment Steps

### 1. Deploy Firestore Rules

```bash
firebase deploy --only firestore:rules
```

### 2. Deploy Firestore Indexes

```bash
firebase deploy --only firestore:indexes
```

### 3. Create Initial Collection (Optional)

If you want to manually create the collection before auto-generation:

1. Go to Firebase Console > Firestore Database
2. Click "Start collection"
3. Collection ID: `contactTasks`
4. Add a test document with the fields above
5. Delete the test document after verifying

## How It Works

### Automatic Task Generation

The system automatically generates contact tasks for:

1. **Consecutive Absences**: Students with 2 or more consecutive school day absences
   - Task Type: `consecutive`
   - Includes number of consecutive days
   - Shows last absent date

2. **Warning Students**: Students flagged with `warning: true` who have absences in the last 7 days
   - Task Type: `warning`
   - Includes student note if available
   - Checks recent 7-day period for any absences

### Task Workflow

1. **Generate**: Click "Generate New Tasks" button to preview potential tasks
2. **Preview**: Review all tasks in the preview modal
   - See consecutive absence tasks (2+ days)
   - See warning student tasks (absences in last 7 days)
   - Select/deselect individual tasks using checkboxes
   - Use "Select All" / "Deselect All" for bulk operations
3. **Confirm**: Click "Create Tasks" to add only the selected tasks
4. **Assign**: Assign tasks to staff members (Jimmy, Jon, Jasper, Jason)
5. **Track**: Update status as you contact parents:
   - `unresolved` → Initial state, not yet contacted
   - `contacted` → Parent has been contacted
   - `resolved` → Issue resolved or task completed
6. **Edit**: Update reason, notes, or reassign as needed
7. **Delete**: Remove tasks that are no longer relevant

### Filtering & Sorting

- Filter by status, task type, or assignee
- Sort by student name, created date, or updated date
- View summary statistics at the bottom

## Best Practices

1. **Regular Generation**: Run "Generate New Tasks" daily to catch new issues
2. **Task Selection**: Review the preview modal and only create relevant tasks
3. **Status Updates**: Update task status immediately after contacting parents
4. **Add Reasons**: Fill in the reason field with contact details and outcomes
5. **Add Notes**: The notes field contains auto-generated context about the absence
6. **Assignment**: Assign tasks to specific staff members for accountability
7. **Cleanup**: Mark tasks as "resolved" when completed to keep the list manageable

## Troubleshooting

### Tasks Not Generating

1. Check that students have proper attendance records
2. Verify class configurations are loaded
3. Check browser console for errors
4. Ensure Firebase connection is active

### Permission Errors

1. Verify user has admin role in Firestore
2. Check security rules are deployed
3. Ensure user is authenticated

### Missing Data

1. Verify all required fields are present
2. Check Firestore indexes are deployed
3. Look for console errors during task creation

## Example Task Document

```json
{
  "studentId": "abc123",
  "studentName": "John Doe",
  "class": "Grade 10",
  "shift": "Morning",
  "taskType": "consecutive",
  "reason": "3 consecutive school day absences. Last absent: 2025-01-14",
  "assignedTo": "Jimmy",
  "status": "unresolved",
  "createdAt": "2025-01-15T08:00:00.000Z",
  "updatedAt": "2025-01-15T08:00:00.000Z",
  "consecutiveDays": 3,
  "lastAbsentDate": "2025-01-14",
  "autoGenerated": true
}
```

## Future Enhancements

- Email notifications when tasks are assigned
- Bulk status updates
- Task templates for common scenarios
- Integration with parent communication system
- Historical task analytics and reporting
