rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTION ---
    // Checks if the user is an admin.
    function isAuthorizedUser() {
      return request.auth != null &&
          exists(/databases/$(database)/documents/authorizedUsers/$(request.auth.token.email));
    }

    // --- COLLECTION RULES ---

    match /students/{studentId} {
      // READ: An admin, the student owner, or anyone querying by username for authentication can read.
      // Also allow reading by document ID for mock exam results (Grade 7-10 students using phone-based IDs)
      allow read: if isAuthorizedUser() || 
                   (request.auth != null && request.auth.uid == resource.data.authUid) ||
                   (request.query.where.size() == 1 && 
                    request.query.where[0].field == 'username' && 
                    request.query.where[0].op == '==') ||
                   true; // Allow public read for mock exam results page

      // CREATE/DELETE: Only admins can create or delete student records.
      allow create, delete: if isAuthorizedUser();
      
      // UPDATE: An admin can update anything. A user can update a record
      // ONLY to link their authUid for the first time, or update their own dateOfBirth.
      allow update: if isAuthorizedUser() ||
                     (request.auth != null &&
                      resource.data.authUid == '' &&
                      request.resource.data.authUid == request.auth.uid) ||
                     (request.auth != null &&
                      request.auth.uid == resource.data.authUid &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['dateOfBirth']));
    }

    match /attendance/{attendanceId} {
      // Admins can do everything with attendance records
      allow read, write: if isAuthorizedUser();

      // Students can create or update their own attendance requests (with status 'requested')
      allow create, update: if request.auth != null &&
        request.resource.data.authUid == request.auth.uid &&
        request.resource.data.status == 'requested';

      // Students can read their own attendance records
      allow read: if request.auth != null && request.auth.uid == resource.data.authUid;
    }
    
    match /classes/{classId} {
      // Only admins can manage class data.
      allow write: if isAuthorizedUser();
      allow read: if true; // Allow public read for registration
    }
    
    match /classConfigs/{classConfigId} {
      // Only admins can manage class configuration data.
      allow write: if isAuthorizedUser();
      allow read: if request.auth != null;
    }
    
    match /examSettings/{settingId} {
      // Allow any authenticated user to read exam settings.
      allow write: if isAuthorizedUser();
  		allow read: if true; // Changed to allow read by everyone
    }
    
  	match /mockExam3/{examId} {
      // Allow any authenticated user to read exam settings.
      allow write: if isAuthorizedUser();
  		allow read: if true; // Changed to allow read by everyone
    }
    
  	match /mockExam1/{examId} {
      // Allow authenticated users (teachers/admins) to write scores
      allow write: if request.auth != null;
  		allow read: if true; // Changed to allow read by everyone
    }
    
  	match /mockExam2/{examId} {
      // Allow any authenticated user to read exam settings.
      allow write: if isAuthorizedUser();
  		allow read: if true; // Changed to allow read by everyone
    }
    
    match /examControls/{controlsId} {
      // Allow any authenticated user to read exam controls (needed for mock exam progress bar).
      allow write: if isAuthorizedUser();
      allow read: if request.auth != null; // Changed from true to require authentication
    }
    
    match /users/{userId}/notifications/{notificationId} {
      // Allow a user to read and write their own notification statuses, but not anyone else's.
      allow read, write: if request.auth.uid == userId;
    }

    match /notifications/{notificationId} {
      // This rule is correct and should stay.
      allow read: if request.auth != null;
      // You may want to restrict write access to admins.
      allow write: if isAuthorizedUser(); 
    }
    
    match /financePW/{financePWId} {
      allow read: if isAuthorizedUser(); 
    }

    
    match /permissions/{permissionId} {
      // Admins can update permissions (approve/deny).
      allow update: if isAuthorizedUser();
      
      // An admin or the student who owns it can read a permission request.
      // IMPORTANT: This requires your 'permissions' documents to have an 'authUid' field.
      allow read: if isAuthorizedUser() || (request.auth != null && request.auth.uid == resource.data.authUid);
      
      // A student can create a permission request for themselves.
      // This rule ensures the 'authUid' in the new document matches the person creating it.
      allow create: if true;
    }

    match /leaveEarlyRequests/{requestId} {
      // Admins can update leave early requests (approve/deny).
      allow update: if isAuthorizedUser();
      
      // An admin or the student who owns it can read a leave early request.
      // IMPORTANT: This requires your 'leaveEarlyRequests' documents to have an 'authUid' field.
      allow read: if isAuthorizedUser() || (request.auth != null && request.auth.uid == resource.data.authUid);
      
      // A student can create a leave early request for themselves.
      // This rule ensures the 'authUid' in the new document matches the person creating it.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authUid;
    }

    match /authorizedUsers/{userEmail} {
      // A user can only read their own authorization status.
      allow get: if request.auth != null && request.auth.token.email == userEmail;
      // Nobody can modify the admin list from the app.
      allow list, create, update, delete: if false;
    }
    
    match /documents/{documentId} {
      // READ: Authenticated users can read document metadata.
      allow read: if request.auth != null;
      
      // CREATE: Authenticated users can upload new documents.
      // In production, you might want to restrict this to admins only.
      allow create: if request.auth != null;
      
      // UPDATE/DELETE: Only admins can modify or delete documents.
      allow update, delete: if isAuthorizedUser();
    }
    
    match /teachers/{teacherId} {
      // READ: Only authenticated users can read teacher information
      // Now that we have Cloud Functions, we don't need unauthenticated access
      allow read: if request.auth != null;
      
      // CREATE/UPDATE/DELETE: Only admins can manage teacher records
      allow create, update, delete: if isAuthorizedUser();
    }
    
    match /appSettings/{appSettingId} {
      // READ: Authenticated users can read document metadata.
      allow read: if request.auth != null;
      
      allow write: if isAuthorizedUser();
    }
    
    match /classTypes/{classTypesId} {
      // READ: Authenticated users can read class types for display purposes
      allow read: if request.auth != null;
      
      // WRITE: Only admins can modify class types
      allow write: if isAuthorizedUser();
    }
        
    match /transactions/{transactionsId} {
      // READ: Authenticated users can read document metadata.
      allow read: if request.auth != null;
      
      allow write: if isAuthorizedUser();
    }
    
    // --- STAR MANAGEMENT SYSTEM RULES ---
    match /starRewards/{rewardId} {
      // READ: Everyone can read star rewards to see available rewards
      allow read: if request.auth != null;
      
      // WRITE: Only admins can create/update/delete star rewards
      allow write: if isAuthorizedUser();
    }
    
    // Star request collection
    match /starRequests/{requestId} {
      // READ: Admins can read all requests, students can read their own
      allow read: if isAuthorizedUser() || 
                     (request.auth != null && request.auth.uid == resource.data.authUid);
      
      // CREATE: Authenticated students can create star requests for themselves
      allow create: if request.auth != null && 
                       request.auth.uid == request.resource.data.authUid;
      
      // UPDATE: Only admins can update star requests (approve/reject)
      allow update: if isAuthorizedUser();
      
      // DELETE: Only admins can delete star requests
      allow delete: if isAuthorizedUser();
    }
    
    // Sub-collection for claimed stars under students
    match /students/{studentId}/claimedStars/{claimedStarId} {
      // READ: Admins can read all, students can read their own
      allow read: if isAuthorizedUser() || 
                     (request.auth != null && request.auth.uid == resource.data.authUid);
      
      // WRITE: Only admins can award stars
      allow write: if isAuthorizedUser();
    }
    
    // Collection group rule for claimedStars (allows collection group queries)
    match /{path=**}/claimedStars/{claimedStarId} {
      allow read: if isAuthorizedUser();
    }
    
    // Sub-collection for transactions under students
    match /students/{studentId}/transactions/{transactionId} {
      // READ: Only admins can read transaction data (financial privacy)
      allow read: if isAuthorizedUser();
      
      // WRITE: Only admins can manage transactions
      allow write: if isAuthorizedUser();
    }
    
    match /processedAbaTransactions/{transactionId} {
      allow read: if isAuthorizedUser() || request.auth == null;
      allow write: if false;
    }
    
    match /tempRegistrationTokens/{tempRegistrationTokensId} {
      allow write, read: if isAuthorizedUser();
    }
    
    match /tempAttendanceTokens/{tempAttendanceTokensId} {
      // Students can read their own tokens, admins can read all
      allow read: if request.auth != null && 
                     (isAuthorizedUser() || request.auth.uid == resource.data.studentUid);
      // Allow any authenticated user to create tokens (API creates with server-side auth)
      allow create: if true;
      // Allow API to update tokens (mark as used)
      allow update: if true;
      // Only admins can delete tokens
      allow delete: if isAuthorizedUser();
    }

    match /printRequests/{requestId} {
      // READ: Authenticated users can read their own requests, admins can read all.
      allow read: if request.auth != null && 
                     (isAuthorizedUser() || request.auth.uid == resource.data.requestedBy);
      
      // CREATE: Authenticated users can create print requests.
      allow create: if request.auth != null;
      
      // UPDATE: Only admins can update print requests (for approval/rejection).
      allow update: if isAuthorizedUser();
      
      // DELETE: Only admins can delete print requests.
      allow delete: if isAuthorizedUser();
    }

    // Contact Tasks Collection - For tracking student follow-ups
    match /contactTasks/{taskId} {
      // Only authenticated admin users can read, write, update, and delete tasks
      allow read, write: if isAuthorizedUser();
    }
    
    match /absentFollowUps/{absentFollowUpId} {
      // READ/WRITE: Only admins can access absent follow-up records.
      allow read, write: if isAuthorizedUser();
    }
    
    match /systemSettings/{systemSettingsId} {
      // READ/WRITE: Only admins can access absent follow-up records.
      allow read, write: if isAuthorizedUser();
    }
    
    match /flipFlopTracking/{flipFlopTrackingId} {
      // READ/WRITE: Only admins can access absent follow-up records.
      allow read, write: if isAuthorizedUser();
    }
    
    match /mockResults/{phoneId} {
      // READ: Authenticated users (teachers/admins) can read student mock results
      allow read: if true;
      
      // WRITE: Authenticated users (teachers/admins) can update mock results
      allow write: if request.auth != null;
    }
    
    match /parentNotifications/{document} {
      // READ/WRITE: Only admins can manage parent notification registrations
      allow read, write: if isAuthorizedUser();
    }
    
    match /absentNotificationSettings/{settingId} {
      // READ/WRITE: Only admins can manage absent notification settings
      allow read, write: if isAuthorizedUser();
    }
    
    match /cleanupLogs/{logId} {
      // READ/WRITE: Only admins can access cleanup logs
      allow read, write: if isAuthorizedUser();
    }
    
    match /fcmTokens/{tokenId} {
      // READ: Authenticated users can read their own tokens, admins can read all
      allow read: if request.auth != null && 
                     (isAuthorizedUser() || request.auth.uid == tokenId);
      
      // CREATE/UPDATE: Users can only write to their own token document (tokenId must match their uid)
      allow create, update: if request.auth != null && 
                               request.auth.uid == tokenId &&
                               request.resource.data.userId == request.auth.uid;
      
      // DELETE: Users can delete their own token
      allow delete: if request.auth != null && request.auth.uid == tokenId;
    }
    
    match /usernameMappings/{mappingId} {
      // Allow anyone to read username mappings for authentication
      allow read: if true;
      // Only admins can write mappings
      allow write: if isAuthorizedUser();
    }
    
    match /backupHistory/{backupId} {
      // READ/WRITE: Only admins can access backup history records
      allow read, write: if isAuthorizedUser();
    }
    
    match /attendance_failed_backup/{backupId} {
      // CREATE: Authenticated users (teachers) can create backup records
      // This is critical - must allow creation even when main attendance save fails
      allow create: if request.auth != null;
      
      // READ: Only admins can read backup records (for manual review)
      allow read: if isAuthorizedUser();
      
      // UPDATE/DELETE: Only admins can update or delete backup records
      allow update, delete: if isAuthorizedUser();
    }
    
    match /events/{eventId} {
      // READ: Authenticated users can read events (to see upcoming events and registration info)
      allow read: if request.auth != null;
      
      // CREATE/UPDATE/DELETE: Only admins can manage events
      allow create, update, delete: if isAuthorizedUser();
    }
    
    match /forms/{formId} {
      // READ: Authenticated users can read forms (application handles active/deadline filtering)
      allow read: if request.auth != null;
      
      // CREATE/UPDATE/DELETE: Only admins can manage forms
      allow create, update, delete: if isAuthorizedUser();
    }

    match /formApprovalActions/{formId} {
      // READ/WRITE: Only admins can manage approval actions for forms
      allow read, write: if isAuthorizedUser();
    }
    
    match /form_responses/{responseId} {
      // READ: Admins can read all responses, students can read their own
      // Allow reading if authUid matches OR if studentUid matches (for backwards compatibility)
      allow read: if isAuthorizedUser() || 
                     (request.auth != null && 
                      (request.auth.uid == resource.data.authUid || 
                       request.auth.uid == resource.data.studentUid));
      
      // CREATE: Admins can create any response (including for students without authUid),
      //         Authenticated students can create their own responses
      allow create: if isAuthorizedUser() ||
                       (request.auth != null && 
                        (request.resource.data.authUid == request.auth.uid ||
                         request.resource.data.studentUid == request.auth.uid));
      
      // UPDATE/DELETE: Only admins can update or delete responses
      allow update, delete: if isAuthorizedUser();
    }
    
    match /examSchedule/{scheduleId} {
      // READ: Authenticated users (teachers/admins) can read exam schedule information
      allow read: if request.auth != null;
      
      // WRITE: Only admins can manage exam schedules
      allow write: if isAuthorizedUser();
    }
    
    match /eventAttendance/{attendanceId} {
      // READ: Admins can read all records, students can read their own
      allow read: if isAuthorizedUser() || 
                     (request.auth != null && request.auth.uid == resource.data.authUid);
      
      // CREATE: Authenticated users can clock in/out (face scan will create records)
      allow create: if request.auth != null;
      
      // UPDATE: Admins can update any record, students can update their own (for clock-out)
      allow update: if isAuthorizedUser() || 
                       (request.auth != null && 
                        request.auth.uid == resource.data.authUid &&
                        resource.data.clockInTime != null); // Only allow updates if already clocked in
      
      // DELETE: Only admins can delete records
      allow delete: if isAuthorizedUser();
    }
    
    match /adminAvailability/{availabilityId} {
      // READ: Anyone can read admin availability (needed for student booking)
      allow read: if true;
      
      // WRITE: Only admins can create, update, or delete availability schedules
      allow write: if isAuthorizedUser();
    }
    
    match /appointmentRequests/{requestId} {
      // READ: Admins can read all requests
      // Students can read all requests to check booked time slots (but limited to status and time fields)
      // Students can also read their own full requests
      allow read: if isAuthorizedUser() || 
                     request.auth != null;
      
      // CREATE: Authenticated students can create appointment requests
      allow create: if request.auth != null &&
                       request.resource.data.authUid == request.auth.uid &&
                       request.resource.data.status == 'pending';
      
      // UPDATE: Only admins can update appointment requests (approve/reject)
      allow update: if isAuthorizedUser();
      
      // DELETE: Only admins can delete appointment requests
      allow delete: if isAuthorizedUser();
    }
    
    match /teachers/{teacherId} {
      // READ: Anyone can read teacher information (needed for student booking)
      allow read: if true;
      
      // WRITE: Only admins can manage teacher records
      allow write: if isAuthorizedUser();
    }
  }
}