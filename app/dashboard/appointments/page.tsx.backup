"use client";

import React, { useState, useEffect } from 'react';
import { toast } from 'sonner';
import { db } from '../../../firebase-config';
import { collection, query, getDocs, getDoc, addDoc, updateDoc, deleteDoc, doc, Timestamp, where, orderBy, deleteField } from 'firebase/firestore';
import { AdminAvailability, AppointmentRequest, AppointmentQuestion } from '../../_interfaces';
import { mdiCalendarClock, mdiPlus, mdiPencil, mdiDelete, mdiCheck, mdiClose, mdiClockOutline, mdiCalendar, mdiAlertCircle, mdiAccountCheck, mdiAccountRemove, mdiChevronDown, mdiChevronUp, mdiAccount, mdiChartLine } from '@mdi/js';
import Icon from '../../_components/Icon';
import DatePicker from '../../_components/DatePicker';
import { getTodayLocalString, formatDateForDisplay } from '../../_utils/dateUtils';
import { StudentDetailsModal as StudentDetailsModalLegacy } from '../students/components/StudentDetailsModal';
import { Student } from '../../_interfaces';
import AdminAvailabilityTab from './_components/AdminAvailabilityTab';
import ScheduleViewTab from './_components/ScheduleViewTab';
import { StudentDetailsModal } from './_components/StudentDetailsModal';

interface SlotInfo {
  time: string;
  date: string;
  status: 'free' | 'pending' | 'approved' | 'rejected';
  request?: AppointmentRequest;
}

interface AppointmentScheduleGridProps {
  availabilities: AdminAvailability[];
  appointmentRequests: AppointmentRequest[];
  onApproveRequest: (request: AppointmentRequest) => void;
  onRejectRequest: (request: AppointmentRequest) => void;
  onDeleteRequest: (request: AppointmentRequest) => void;
  onMarkAttendance: (request: AppointmentRequest, status: 'met' | 'no-show') => void;
  onEditMeeting: (request: AppointmentRequest) => void;
}

const AppointmentScheduleGrid: React.FC<AppointmentScheduleGridProps> = ({
  availabilities,
  appointmentRequests,
  onApproveRequest,
  onRejectRequest,
  onDeleteRequest,
  onMarkAttendance,
  onEditMeeting
}) => {
  const [expandedSlots, setExpandedSlots] = useState<Set<string>>(new Set());
  const [selectedStudent, setSelectedStudent] = useState<Student | null>(null);
  const [showStudentModal, setShowStudentModal] = useState(false);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [detailData, setDetailData] = useState<any>(null);
  const [loadingDetail, setLoadingDetail] = useState(false);
  const [expandedDetailSections, setExpandedDetailSections] = useState<Set<string>>(new Set(['exam', 'answers']));

  const toggleSlot = (slotKey: string) => {
    setExpandedSlots(prev => {
      const newSet = new Set(prev);
      if (newSet.has(slotKey)) {
        newSet.delete(slotKey);
      } else {
        newSet.add(slotKey);
      }
      return newSet;
    });
  };

  const fetchStudentDetails = async (studentId: string) => {
    try {
      const studentDocRef = doc(db, 'students', studentId);
      const studentDoc = await getDoc(studentDocRef);
      if (studentDoc.exists()) {
        const studentData = { id: studentDoc.id, ...studentDoc.data() } as Student;
        setSelectedStudent(studentData);
        setShowStudentModal(true);
      } else {
        toast.error('Student not found');
      }
    } catch (error) {
      console.error('Error fetching student details:', error);
      toast.error('Failed to load student details');
    }
  };

  const fetchExamResults = async (studentId: string, studentName: string, appointmentRequest?: AppointmentRequest) => {
    try {
      setLoadingDetail(true);
      setShowDetailModal(true);
      
      // Query mockExam1 collection for this student
      const mockExamQuery = query(
        collection(db, 'mockExam1'),
        where('studentId', '==', studentId)
      );
      
      const snapshot = await getDocs(mockExamQuery);
      
      let examResultsData: any = null;
      if (!snapshot.empty) {
        const examData = snapshot.docs[0].data();
        const mock1Result = examData.mock1Result || {};
        const classType = examData.classType || 'N/A';
        
        // Fetch exam settings to get max scores
        const examSettingsQuery = query(
          collection(db, 'examSettings'),
          where('mock', '==', 'mock1')
        );
        
        const settingsSnapshot = await getDocs(examSettingsQuery);
        const maxScoresMap: { [key: string]: number } = {};
        
        // Build map with key format: "Grade 12_math" -> maxScore
        settingsSnapshot.forEach((doc) => {
          const data = doc.data();
          const key = `${data.type}_${data.subject}`;
          maxScoresMap[key] = data.maxScore;
        });
        
        // Clean scores object - ensure only numbers are included
        const cleanedScores: { [key: string]: number } = {};
        Object.entries(mock1Result).forEach(([key, value]) => {
          // Only include numeric values or -1 (for absent)
          if (typeof value === 'number') {
            cleanedScores[key] = value;
          }
        });
        
        examResultsData = {
          studentName: examData.fullName || studentName,
          classType: classType,
          scores: cleanedScores,
          maxScoresMap: maxScoresMap,
        };
      } else {
        examResultsData = {
          studentName,
          classType: 'N/A',
          scores: {},
          maxScoresMap: {},
          noData: true,
        };
      }
      
      // Combine exam results with appointment answers
      setDetailData({
        studentName: studentName,
        studentId: studentId,
        appointmentRequest: appointmentRequest,
        examResults: examResultsData,
      });
    } catch (error) {
      console.error('Error fetching details:', error);
      toast.error('Failed to load details');
      setShowDetailModal(false);
    } finally {
      setLoadingDetail(false);
    }
  };

  const toggleDetailSection = (section: string) => {
    setExpandedDetailSections(prev => {
      const newSet = new Set(prev);
      if (newSet.has(section)) {
        newSet.delete(section);
      } else {
        newSet.add(section);
      }
      return newSet;
    });
  };
  // Generate all time slots for active availabilities
  const generateTimeSlots = (availability: AdminAvailability): SlotInfo[] => {
    const slots: SlotInfo[] = [];
    const startTime = new Date(`2000-01-01T${availability.startTime}`);
    const endTime = new Date(`2000-01-01T${availability.endTime}`);
    const slotDuration = availability.slotDuration;

    let currentTime = new Date(startTime);

    while (currentTime < endTime) {
      const timeString = currentTime.toTimeString().slice(0, 5); // HH:MM format
      
      // Find matching appointment request
      const matchingRequest = appointmentRequests.find(req => 
        req.appointmentDate === availability.date && 
        req.appointmentTime === timeString
      );

      slots.push({
        time: timeString,
        date: availability.date,
        status: matchingRequest ? matchingRequest.status as 'pending' | 'approved' | 'rejected' : 'free',
        request: matchingRequest
      });

      currentTime.setMinutes(currentTime.getMinutes() + slotDuration);
    }

    return slots;
  };

  // Group slots by date
  const slotsByDate = availabilities.reduce((acc, availability) => {
    const date = availability.date;
    if (!acc[date]) acc[date] = [];
    acc[date].push(...generateTimeSlots(availability));
    return acc;
  }, {} as Record<string, SlotInfo[]>);

  // Sort dates
  const sortedDates = Object.keys(slotsByDate).sort();

  const getSlotColor = (status: string) => {
    switch (status) {
      case 'free': return 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700';
      case 'pending': return 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-700';
      case 'approved': return 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700';
      case 'rejected': return 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-700';
      default: return 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700';
    }
  };

  const getSlotIcon = (status: string) => {
    switch (status) {
      case 'pending': return mdiClockOutline;
      case 'approved': return mdiCheck;
      case 'rejected': return mdiClose;
      default: return null;
    }
  };

  if (sortedDates.length === 0) {
    return (
      <div className="text-center py-16 bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm rounded-2xl border border-slate-200/50 dark:border-slate-700/50">
        <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-600 rounded-2xl mb-4">
          <Icon path={mdiCalendarClock} size={16} className="text-slate-400 dark:text-slate-500" />
        </div>
        <h3 className="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-2">No availability schedules</h3>
        <p className="text-slate-600 dark:text-slate-400">Create availability schedules in the Admin Availability tab first</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {sortedDates.map(date => (
        <div key={date} className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-2xl p-6 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 border border-slate-200/50 dark:border-slate-700/50">
          <div className="flex items-center gap-3 mb-6">
            <div className="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-xl shadow-lg shadow-purple-500/25">
              <Icon path={mdiCalendar} size={16} className="text-white" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-slate-800 dark:text-slate-200">
                {formatDateForDisplay(date)}
              </h3>
              <p className="text-sm text-slate-600 dark:text-slate-400">
                {slotsByDate[date].length} time slots available
              </p>
            </div>
          </div>

          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-3">
            {slotsByDate[date].map((slot, index) => {
              const slotKey = `${slot.date}-${slot.time}-${index}`;
              const isExpanded = expandedSlots.has(slotKey);
              
              return (
                <div
                  key={slotKey}
                  className={`relative border rounded-xl p-3 transition-all duration-200 ${getSlotColor(slot.status)} ${
                    slot.status !== 'free' ? 'cursor-default' : 'cursor-pointer'
                  }`}
                >
                  <div className="text-center">
                    <div className="text-sm font-medium text-slate-800 dark:text-slate-200 mb-1">
                      {slot.time}
                    </div>
                    
                    {slot.status !== 'free' && slot.request && (
                      <div className="space-y-2">
                        <div className="flex items-center justify-center gap-1">
                          {getSlotIcon(slot.status) && (
                            <Icon 
                              path={getSlotIcon(slot.status)!} 
                              size={12} 
                              className={`${
                                slot.status === 'approved' ? 'text-green-600' :
                                slot.status === 'rejected' ? 'text-red-600' :
                                'text-yellow-600'
                              }`} 
                            />
                          )}
                          <span className={`text-xs font-medium capitalize ${
                            slot.status === 'approved' ? 'text-green-700 dark:text-green-300' :
                            slot.status === 'rejected' ? 'text-red-700 dark:text-red-300' :
                            'text-yellow-700 dark:text-yellow-300'
                          }`}>
                            {slot.status}
                          </span>
                        </div>
                        
                        <div className="text-xs text-slate-600 dark:text-slate-400 truncate">
                          {slot.request.studentName}
                        </div>
                        {slot.request.studentClass && (
                          <div className="text-xs text-slate-500 dark:text-slate-500">
                            {slot.request.studentClass}
                          </div>
                        )}
                        
                        {/* Expand/Collapse Button */}
                        {slot.status === 'approved' && (
                          <button
                            onClick={() => toggleSlot(slotKey)}
                            className="w-full bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-xs px-2 py-1 rounded hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors flex items-center justify-center gap-1"
                          >
                            <Icon path={isExpanded ? mdiChevronUp : mdiChevronDown} size={12} />
                            {isExpanded ? 'Hide' : 'Show'} Actions
                          </button>
                        )}
                        
                        {/* Expanded Content - Only for approved slots */}
                        {slot.status === 'approved' && isExpanded && (
                          <div className="space-y-2 pt-2 border-t border-slate-300 dark:border-slate-600">
                            {slot.request.attendanceStatus ? (
                              <div className={`text-xs font-medium px-2 py-1 rounded ${
                                slot.request.attendanceStatus === 'met' 
                                  ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' 
                                  : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'
                              }`}>
                                {slot.request.attendanceStatus === 'met' ? '✓ Met' : '✕ No Show'}
                              </div>
                            ) : (
                              <div className="space-y-1">
                                <button
                                  onClick={() => onMarkAttendance(slot.request!, 'met')}
                                  className="w-full bg-green-600 text-white text-xs px-2 py-1 rounded hover:bg-green-700 transition-colors flex items-center justify-center gap-1"
                                  title="Mark as Met"
                                >
                                  <Icon path={mdiAccountCheck} size={12} />
                                  Met
                                </button>
                                <button
                                  onClick={() => onMarkAttendance(slot.request!, 'no-show')}
                                  className="w-full bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-700 transition-colors flex items-center justify-center gap-1"
                                  title="Mark as No Show"
                                >
                                  <Icon path={mdiAccountRemove} size={12} />
                                  No Show
                                </button>
                              </div>
                              )}
                            
                            <div className="border-t border-slate-300 dark:border-slate-600 my-1"></div>
                            
                            <button
                              onClick={() => onEditMeeting(slot.request!)}
                              className="w-full bg-blue-600 text-white text-xs px-2 py-1 rounded hover:bg-blue-700 transition-colors flex items-center justify-center gap-1"
                              title="Edit Meeting Time"
                            >
                              <Icon path={mdiPencil} size={12} />
                              Edit Time
                            </button>
                            
                            <button
                              onClick={() => fetchStudentDetails(slot.request!.studentId)}
                              className="w-full bg-purple-600 text-white text-xs px-2 py-1 rounded hover:bg-purple-700 transition-colors flex items-center justify-center gap-1"
                              title="View Student Details"
                            >
                              <Icon path={mdiAccount} size={12} />
                              View Student
                            </button>                            <button
                              onClick={() => fetchExamResults(slot.request!.studentId, slot.request!.studentName, slot.request!)}
                              className="w-full bg-indigo-600 text-white text-xs px-2 py-1 rounded hover:bg-indigo-700 transition-colors flex items-center justify-center gap-1"
                              title="View Details"
                            >
                              <Icon path={mdiChartLine} size={12} />
                              View Details
                            </button>
                          </div>
                        )}
                        
                        {/* Pending status buttons */}
                        {slot.status === 'pending' && (
                          <div className="flex gap-1 mt-2 flex-col">
                            <div className="flex gap-1">
                              <button
                                onClick={() => onApproveRequest(slot.request!)}
                                className="flex-1 bg-green-600 text-white text-xs px-2 py-1 rounded hover:bg-green-700 transition-colors"
                                title="Approve"
                              >
                                ✓
                              </button>
                              <button
                                onClick={() => onRejectRequest(slot.request!)}
                                className="flex-1 bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-700 transition-colors"
                                title="Reject"
                              >
                                ✕
                              </button>
                            </div>
                            <button
                              onClick={() => onEditMeeting(slot.request!)}
                              className="w-full bg-blue-600 text-white text-xs px-2 py-1 rounded hover:bg-blue-700 transition-colors flex items-center justify-center gap-1"
                              title="Edit Meeting Time"
                            >
                              <Icon path={mdiPencil} size={12} />
                              Edit
                            </button>
                          </div>
                        )}
                        
                        {/* Rejected reason */}
                        {slot.status === 'rejected' && slot.request.rejectionReason && (
                          <div className="text-xs text-red-600 dark:text-red-400 mt-1 truncate" title={slot.request.rejectionReason}>
                            {slot.request.rejectionReason}
                          </div>
                        )}
                      </div>
                    )}
                    
                    {slot.status === 'free' && (
                      <div className="text-xs text-slate-500 dark:text-slate-400">
                        Available
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
      
      {/* Student Details Modal */}
      <StudentDetailsModal
        student={selectedStudent}
        isOpen={showStudentModal}
        onClose={() => {
          setShowStudentModal(false);
          setSelectedStudent(null);
        }}
        onEdit={() => {}}
        onDelete={() => {}}
        hideActions={true}
        defaultTab="basic"
        students={selectedStudent ? [selectedStudent] : []}
        currentIndex={0}
      />
      
      {/* Unified Detail Modal */}
      {showDetailModal && detailData && (
        <div className="fixed inset-0 bg-[rgba(0,0,0,0.6)] backdrop-blur-sm flex items-center justify-center z-120 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                  <Icon path={mdiChartLine} size={24} className="text-white" />
                </div>
                <div>
                  <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Student Details</h2>
                  <p className="text-sm text-gray-600 dark:text-gray-400">{detailData.studentName}</p>
                </div>
              </div>
              <button
                onClick={() => {
                  setShowDetailModal(false);
                  setDetailData(null);
                }}
                className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
              >
                <Icon path={mdiClose} size={20} className="text-gray-600 dark:text-gray-400" />
              </button>
            </div>

            {loadingDetail ? (
              <div className="flex flex-col items-center justify-center py-12">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                <p className="text-gray-600 dark:text-gray-400">Loading details...</p>
              </div>
            ) : (
              <div className="space-y-4">
                {/* Exam Results Section */}
                {detailData.examResults && (
                  <div className="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden">
                    <button
                      onClick={() => toggleDetailSection('exam')}
                      className="w-full px-4 py-3 bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 hover:from-indigo-100 hover:to-purple-100 dark:hover:from-indigo-900/30 dark:hover:to-purple-900/30 flex items-center justify-between transition-all duration-300"
                    >
                      <div className="flex items-center gap-3">
                        <Icon 
                          path={expandedDetailSections.has('exam') ? mdiChevronUp : mdiChevronDown} 
                          size={20} 
                          className="text-indigo-600 dark:text-indigo-400" 
                        />
                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white">Mock Exam Results</h3>
                      </div>
                      <span className="text-sm text-gray-600 dark:text-gray-400">
                        {detailData.examResults.classType}
                      </span>
                    </button>
                    
                    {expandedDetailSections.has('exam') && (
                      <div className="px-4 py-4 border-t border-gray-200 dark:border-gray-700 space-y-4 animate-in fade-in slide-in-from-top-2 duration-300">
                        {detailData.examResults.noData ? (
                          <div className="text-center py-8">
                            <Icon path={mdiAlertCircle} size={32} className="mx-auto text-gray-400 dark:text-gray-600 mb-2" />
                            <p className="text-gray-600 dark:text-gray-400">No exam results found</p>
                          </div>
                        ) : (
                          <>
                            {/* Subject Scores */}
                            <div>
                              <h4 className="font-semibold text-gray-900 dark:text-white mb-3">Subject Scores</h4>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {Object.keys(detailData.examResults.scores).length > 0 ? (
                                  Object.entries(detailData.examResults.scores).map(([subject, score]: [string, any]) => {
                                    const maxScoreKey = `${detailData.examResults.classType}_${subject}`;
                                    const maxScore = detailData.examResults.maxScoresMap[maxScoreKey] || 100;
                                    const actualScore = score === -1 ? 0 : (score || 0);
                                    const percentage = maxScore > 0 ? (actualScore / maxScore) * 100 : 0;
                                    const grade = percentage >= 90 ? 'A' : percentage >= 80 ? 'B' : percentage >= 70 ? 'C' : percentage >= 60 ? 'D' : percentage >= 50 ? 'E' : 'F';
                                    
                                    const getGradeColor = (g: string) => {
                                      switch(g) {
                                        case 'A': return 'from-green-500 to-emerald-500';
                                        case 'B': return 'from-blue-500 to-cyan-500';
                                        case 'C': return 'from-purple-500 to-pink-500';
                                        case 'D': return 'from-yellow-500 to-amber-500';
                                        case 'E': return 'from-orange-500 to-red-400';
                                        case 'F': return 'from-red-500 to-rose-500';
                                        default: return 'from-gray-500 to-slate-500';
                                      }
                                    };

                                    return (
                                      <div key={subject} className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 border border-gray-200 dark:border-gray-600">
                                        <div className="flex items-center justify-between mb-3">
                                          <h5 className="font-medium text-gray-900 dark:text-white capitalize text-sm">{subject}</h5>
                                          <span className={`px-4 py-2 rounded-full text-base font-bold text-white bg-gradient-to-r ${getGradeColor(grade)} shadow-md`}>
                                            {grade}
                                          </span>
                                        </div>
                                        <div className="text-sm">
                                          <span className="text-gray-600 dark:text-gray-400">
                                            {score === -1 ? 'Absent' : `${score || 0} / ${maxScore}`}
                                          </span>
                                        </div>
                                      </div>
                                    );
                                  })
                                ) : (
                                  <div className="col-span-2 text-center py-4 text-gray-500 dark:text-gray-400">
                                    No subject scores available
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* Overall Performance */}
                            {Object.keys(detailData.examResults.scores).length > 0 && (() => {
                              const scores = Object.values(detailData.examResults.scores) as number[];
                              const totalScore = scores.reduce((sum, s) => sum + (s === -1 ? 0 : (s || 0)), 0);
                              const subjects = Object.keys(detailData.examResults.scores);
                              let totalMaxScore = 0;
                              subjects.forEach(subject => {
                                const maxScoreKey = `${detailData.examResults.classType}_${subject}`;
                                totalMaxScore += detailData.examResults.maxScoresMap[maxScoreKey] || 100;
                              });
                              
                              const percentage = totalMaxScore > 0 ? (totalScore / totalMaxScore) * 100 : 0;
                              const totalGrade = percentage >= 90 ? 'A' : percentage >= 80 ? 'B' : percentage >= 70 ? 'C' : percentage >= 60 ? 'D' : percentage >= 50 ? 'E' : 'F';
                              
                              const getGradeColor = (g: string) => {
                                switch(g) {
                                  case 'A': return 'from-green-500 to-emerald-500';
                                  case 'B': return 'from-blue-500 to-cyan-500';
                                  case 'C': return 'from-purple-500 to-pink-500';
                                  case 'D': return 'from-yellow-500 to-amber-500';
                                  case 'E': return 'from-orange-500 to-red-400';
                                  case 'F': return 'from-red-500 to-rose-500';
                                  default: return 'from-gray-500 to-slate-500';
                                }
                              };
                              
                              return (
                                <div className="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-lg p-4 border border-indigo-200 dark:border-indigo-700">
                                  <h4 className="font-semibold text-gray-900 dark:text-white mb-3">Overall Performance</h4>
                                  <div className="grid grid-cols-2 gap-4">
                                    <div>
                                      <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">Total Score</p>
                                      <p className="text-xl font-bold text-indigo-600 dark:text-indigo-400">
                                        {totalScore} / {totalMaxScore}
                                      </p>
                                      <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                        {percentage.toFixed(1)}%
                                      </p>
                                    </div>
                                    <div>
                                      <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">Total Grade</p>
                                      <span className={`inline-block px-4 py-2 rounded-lg text-lg font-bold text-white bg-gradient-to-r ${getGradeColor(totalGrade)}`}>
                                        {totalGrade}
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              );
                            })()}
                          </>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {/* Student Answers Section */}
                {detailData.appointmentRequest && detailData.appointmentRequest.answers && detailData.appointmentRequest.answers.length > 0 && (
                  <div className="border border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden">
                    <button
                      onClick={() => toggleDetailSection('answers')}
                      className="w-full px-4 py-3 bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 hover:from-blue-100 hover:to-cyan-100 dark:hover:from-blue-900/30 dark:hover:to-cyan-900/30 flex items-center justify-between transition-all duration-300"
                    >
                      <div className="flex items-center gap-3">
                        <Icon 
                          path={expandedDetailSections.has('answers') ? mdiChevronUp : mdiChevronDown} 
                          size={20} 
                          className="text-blue-600 dark:text-blue-400" 
                        />
                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white">Student Answers</h3>
                      </div>
                      <span className="text-sm text-gray-600 dark:text-gray-400">
                        {detailData.appointmentRequest.answers.filter((a: any) => a.meetsRequirement).length} / {detailData.appointmentRequest.answers.length} valid
                      </span>
                    </button>
                    
                    {expandedDetailSections.has('answers') && (
                      <div className="px-4 py-4 border-t border-gray-200 dark:border-gray-700 space-y-4 animate-in fade-in slide-in-from-top-2 duration-300">
                        {detailData.appointmentRequest.answers.map((answer: any, index: number) => (
                          <div key={index} className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 border border-gray-200 dark:border-gray-600">
                            <div className="flex items-start justify-between mb-2">
                              <div>
                                <h4 className="font-medium text-gray-900 dark:text-white text-sm">Question {index + 1}</h4>
                                <p className="text-xs text-gray-600 dark:text-gray-400 mt-1">{answer.question}</p>
                              </div>
                              <div className={`px-2 py-1 rounded text-xs font-medium whitespace-nowrap ml-2 ${
                                answer.meetsRequirement 
                                  ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300' 
                                  : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300'
                              }`}>
                                {answer.meetsRequirement ? '✓ Valid' : '✗ Invalid'}
                              </div>
                            </div>

                            <div className="bg-white dark:bg-gray-800 rounded p-2 mb-2 text-xs text-gray-900 dark:text-gray-100 line-clamp-3">
                              {answer.answer}
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                              <div className="bg-blue-50 dark:bg-blue-900/20 rounded p-2 text-center">
                                <p className="text-xs text-gray-600 dark:text-gray-400">Words</p>
                                <p className="text-sm font-bold text-blue-600 dark:text-blue-400">{answer.wordCount || 0}</p>
                              </div>
                              <div className="bg-purple-50 dark:bg-purple-900/20 rounded p-2 text-center">
                                <p className="text-xs text-gray-600 dark:text-gray-400">Status</p>
                                <p className="text-sm font-bold text-purple-600 dark:text-purple-400">{answer.meetsRequirement ? 'Valid' : 'Invalid'}</p>
                              </div>
                            </div>
                          </div>
                        ))}

                        {/* Answers Summary */}
                        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 rounded-lg p-3 border border-blue-200 dark:border-blue-700">
                          <h4 className="font-semibold text-gray-900 dark:text-white text-sm mb-2">Summary</h4>
                          <div className="grid grid-cols-3 gap-2">
                            <div className="text-center">
                              <p className="text-xs text-gray-600 dark:text-gray-400">Total</p>
                              <p className="text-lg font-bold text-blue-600 dark:text-blue-400">{detailData.appointmentRequest.answers.length}</p>
                            </div>
                            <div className="text-center">
                              <p className="text-xs text-gray-600 dark:text-gray-400">Valid</p>
                              <p className="text-lg font-bold text-green-600 dark:text-green-400">{detailData.appointmentRequest.answers.filter((a: any) => a.meetsRequirement).length}</p>
                            </div>
                            <div className="text-center">
                              <p className="text-xs text-gray-600 dark:text-gray-400">Avg Words</p>
                              <p className="text-lg font-bold text-purple-600 dark:text-purple-400">
                                {(detailData.appointmentRequest.answers.reduce((sum: number, a: any) => sum + (a.wordCount || 0), 0) / detailData.appointmentRequest.answers.length).toFixed(0)}
                              </p>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            <div className="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
              <button
                onClick={() => {
                  setShowDetailModal(false);
                  setDetailData(null);
                }}
                className="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}


    </div>
  );
};

const AppointmentsManagementPage = () => {
  const [availabilities, setAvailabilities] = useState<AdminAvailability[]>([]);
  const [appointmentRequests, setAppointmentRequests] = useState<AppointmentRequest[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'availability' | 'schedule'>('availability');
  
  // Form state for creating/editing availability
  const [showAvailabilityForm, setShowAvailabilityForm] = useState(false);
  const [editingAvailability, setEditingAvailability] = useState<AdminAvailability | null>(null);
  
  // Delete confirmation modal state
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [requestToDelete, setRequestToDelete] = useState<AppointmentRequest | null>(null);
  
  // Edit meeting time modal state
  const [showEditMeetingModal, setShowEditMeetingModal] = useState(false);
  const [editingMeetingRequest, setEditingMeetingRequest] = useState<AppointmentRequest | null>(null);
  const [editMeetingDate, setEditMeetingDate] = useState('');
  const [editMeetingTime, setEditMeetingTime] = useState('');
  const [availableDaysForEdit, setAvailableDaysForEdit] = useState<string[]>([]);
  const [availableSlotsForEdit, setAvailableSlotsForEdit] = useState<Array<{ date: string; time: string }>>([]);
  
  // Get today's date in YYYY-MM-DD format
  const today = getTodayLocalString();
  
  const [formData, setFormData] = useState({
    date: today,
    startTime: '09:00',
    endTime: '17:00',
    slotDuration: 30,
    minPriorHours: 2,
    downtimeStart: '',
    downtimeEnd: '',
    questions: [] as AppointmentQuestion[],
  });
  
  const [newQuestion, setNewQuestion] = useState({
    question: '',
    minWordCount: 0,
  });

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setIsLoading(true);
    try {
      // Load availabilities sorted by date
      const availabilitiesQuery = query(collection(db, 'adminAvailability'), orderBy('date'), orderBy('startTime'));
      const availabilitiesSnapshot = await getDocs(availabilitiesQuery);
      const availabilitiesData = availabilitiesSnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      } as AdminAvailability));
      setAvailabilities(availabilitiesData);

      // Load appointment requests
      const requestsQuery = query(
        collection(db, 'appointmentRequests'),
        orderBy('requestedAt', 'desc')
      );
      const requestsSnapshot = await getDocs(requestsQuery);
      const requestsData = requestsSnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      } as AppointmentRequest));
      setAppointmentRequests(requestsData);
    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const handleSaveAvailability = async () => {
    try {
      const availabilityData: any = {
        date: formData.date,
        startTime: formData.startTime,
        endTime: formData.endTime,
        slotDuration: formData.slotDuration,
        minPriorHours: formData.minPriorHours,
        isActive: true,
        updatedAt: Timestamp.now(),
        updatedBy: 'admin',
      };

      // Add downtime if specified
      if (formData.downtimeStart && formData.downtimeEnd) {
        availabilityData.downtimeStart = formData.downtimeStart;
        availabilityData.downtimeEnd = formData.downtimeEnd;
      }

      // Add questions if specified
      if (formData.questions && formData.questions.length > 0) {
        availabilityData.questions = formData.questions;
      }

      if (editingAvailability) {
        // Update existing
        const availabilityRef = doc(db, 'adminAvailability', editingAvailability.id);
        await updateDoc(availabilityRef, availabilityData);
      } else {
        // Create new
        await addDoc(collection(db, 'adminAvailability'), {
          ...availabilityData,
          createdAt: Timestamp.now(),
          createdBy: 'admin',
        });
      }

      setShowAvailabilityForm(false);
      setEditingAvailability(null);
      setFormData({
        date: today,
        startTime: '09:00',
        endTime: '17:00',
        slotDuration: 30,
        minPriorHours: 2,
        downtimeStart: '',
        downtimeEnd: '',
        questions: [],
      });
      loadData();
      toast.success(editingAvailability ? 'Availability updated successfully!' : 'Availability created successfully!');
    } catch (error) {
      console.error('Error saving availability:', error);
      toast.error('Failed to save availability');
    }
  };

  const handleDeleteAvailability = async (id: string) => {
    if (!confirm('Are you sure you want to delete this availability?')) return;
    
    try {
      await deleteDoc(doc(db, 'adminAvailability', id));
      loadData();
      toast.success('Availability deleted successfully!');
    } catch (error) {
      console.error('Error deleting availability:', error);
      toast.error('Failed to delete availability');
    }
  };

  const handleToggleAvailability = async (availability: AdminAvailability) => {
    try {
      const availabilityRef = doc(db, 'adminAvailability', availability.id);
      await updateDoc(availabilityRef, {
        isActive: !availability.isActive,
        updatedAt: Timestamp.now(),
        updatedBy: 'admin',
      });
      // Update local state without refreshing the page
      setAvailabilities(prevAvailabilities =>
        prevAvailabilities.map(a =>
          a.id === availability.id ? { ...a, isActive: !a.isActive } : a
        )
      );
    } catch (error) {
      console.error('Error toggling availability:', error);
      toast.error('Failed to toggle availability');
    }
  };

  const handleApproveRequest = async (request: AppointmentRequest) => {
    try {
      const requestRef = doc(db, 'appointmentRequests', request.id);
      await updateDoc(requestRef, {
        status: 'approved',
        processedAt: Timestamp.now(),
        processedBy: 'admin',
      });
      loadData();
      toast.success('Appointment approved successfully!');
    } catch (error) {
      console.error('Error approving request:', error);
      toast.error('Failed to approve request');
    }
  };

  const handleDeleteRequest = async (request: AppointmentRequest) => {
    setRequestToDelete(request);
    setShowDeleteModal(true);
  };

  const confirmDeleteRequest = async () => {
    if (!requestToDelete) return;

    try {
      await deleteDoc(doc(db, 'appointmentRequests', requestToDelete.id));
      loadData();
      toast.success('Appointment request deleted successfully!');
    } catch (error) {
      console.error('Error deleting request:', error);
      toast.error('Failed to delete request');
    } finally {
      setShowDeleteModal(false);
      setRequestToDelete(null);
    }
  };

  const cancelDeleteRequest = () => {
    setShowDeleteModal(false);
    setRequestToDelete(null);
  };

  const handleRejectRequest = async (request: AppointmentRequest) => {
    const reason = prompt('Please enter rejection reason:');
    if (!reason) return;

    try {
      const requestRef = doc(db, 'appointmentRequests', request.id);
      await updateDoc(requestRef, {
        status: 'rejected',
        rejectionReason: reason,
        processedAt: Timestamp.now(),
        processedBy: 'admin',
      });
      loadData();
      toast.success('Appointment rejected.');
    } catch (error) {
      console.error('Error rejecting request:', error);
      toast.error('Failed to reject request');
    }
  };

  const handleMarkAttendance = async (request: AppointmentRequest, status: 'met' | 'no-show') => {
    try {
      const requestRef = doc(db, 'appointmentRequests', request.id);
      await updateDoc(requestRef, {
        attendanceStatus: status,
        attendanceMarkedAt: Timestamp.now(),
        attendanceMarkedBy: 'admin',
      });
      loadData();
      toast.success(`Appointment marked as ${status === 'met' ? 'Met' : 'No Show'}`);
    } catch (error) {
      console.error('Error marking attendance:', error);
      toast.error('Failed to mark attendance');
    }
  };

  const openEditMeetingModal = (request: AppointmentRequest) => {
    setEditingMeetingRequest(request);
    setEditMeetingDate('');
    setEditMeetingTime('');
    
    // Generate available days from active availabilities
    const daysSet = new Set<string>();
    
    availabilities.filter(a => a.isActive).forEach(availability => {
      daysSet.add(availability.date);
    });
    
    const days = Array.from(daysSet).sort();
    setAvailableDaysForEdit(days);
    setAvailableSlotsForEdit([]);
    setShowEditMeetingModal(true);
  };

  const handleSelectDateForEdit = (date: string) => {
    setEditMeetingDate(date);
    setEditMeetingTime('');
    
    // Generate available slots for selected date
    const slots: Array<{ date: string; time: string }> = [];
    
    availabilities
      .filter(a => a.isActive && a.date === date)
      .forEach(availability => {
        const startTime = new Date(`2000-01-01T${availability.startTime}`);
        const endTime = new Date(`2000-01-01T${availability.endTime}`);
        const slotDuration = availability.slotDuration;
        
        let currentTime = new Date(startTime);
        
        while (currentTime < endTime) {
          const timeString = currentTime.toTimeString().slice(0, 5);
          
          // Check if this slot is already booked (excluding current request)
          const isBooked = appointmentRequests.some(req =>
            req.id !== editingMeetingRequest!.id &&
            req.appointmentDate === date &&
            req.appointmentTime === timeString &&
            (req.status === 'approved' || req.status === 'pending')
          );
          
          if (!isBooked) {
            slots.push({
              date: date,
              time: timeString
            });
          }
          
          currentTime.setMinutes(currentTime.getMinutes() + slotDuration);
        }
      });
    
    setAvailableSlotsForEdit(slots);
  };

  const handleUpdateMeetingTime = async () => {
    if (!editingMeetingRequest || !editMeetingDate || !editMeetingTime) {
      toast.error('Please select a date and time');
      return;
    }

    // Verify selected slot is in available slots (as a final check)
    const slotExists = availableSlotsForEdit.some(slot =>
      slot.date === editMeetingDate && slot.time === editMeetingTime
    );

    if (!slotExists) {
      toast.error('Selected slot is no longer available. Please select another slot.');
      return;
    }

    try {
      const requestRef = doc(db, 'appointmentRequests', editingMeetingRequest.id);
      const updateData: any = {
        appointmentDate: editMeetingDate,
        appointmentTime: editMeetingTime,
        updatedAt: Timestamp.now(),
        updatedBy: 'admin',
      };

      // If current attendance status is 'no-show', change appointment status to 'approved' and clear attendance
      if (editingMeetingRequest.attendanceStatus === 'no-show') {
        updateData.status = 'approved';
        updateData.attendanceStatus = deleteField();
        updateData.attendanceMarkedAt = deleteField();
        updateData.attendanceMarkedBy = deleteField();
      }

      await updateDoc(requestRef, updateData);
      loadData();
      setShowEditMeetingModal(false);
      setEditingMeetingRequest(null);
      setAvailableSlotsForEdit([]);
      toast.success('Meeting time updated successfully!');
    } catch (error) {
      console.error('Error updating meeting time:', error);
      toast.error('Failed to update meeting time');
    }
  };

  const closeEditMeetingModal = () => {
    setShowEditMeetingModal(false);
    setEditingMeetingRequest(null);
    setEditMeetingDate('');
    setEditMeetingTime('');
    setAvailableSlotsForEdit([]);
  };

  const startEditAvailability = (availability: AdminAvailability) => {
    setEditingAvailability(availability);
    setFormData({
      date: availability.date,
      startTime: availability.startTime,
      endTime: availability.endTime,
      slotDuration: availability.slotDuration,
      minPriorHours: availability.minPriorHours || 2,
      downtimeStart: availability.downtimeStart || '',
      downtimeEnd: availability.downtimeEnd || '',
      questions: availability.questions || [],
    });
    setShowAvailabilityForm(true);
  };

  const cancelForm = () => {
    setShowAvailabilityForm(false);
    setEditingAvailability(null);
    setFormData({
      date: today,
      startTime: '09:00',
      endTime: '17:00',
      slotDuration: 30,
      minPriorHours: 2,
      downtimeStart: '',
      downtimeEnd: '',
      questions: [],
    });
    setNewQuestion({
      question: '',
      minWordCount: 0,
    });
  };

  const handleAddQuestion = () => {
    if (!newQuestion.question.trim()) {
      toast.error('Please enter a question');
      return;
    }
    
    const question: AppointmentQuestion = {
      id: `q_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      question: newQuestion.question,
      minWordCount: newQuestion.minWordCount,
      required: true,
      order: formData.questions.length + 1,
    };
    
    setFormData(prev => ({
      ...prev,
      questions: [...prev.questions, question]
    }));
    
    setNewQuestion({
      question: '',
      minWordCount: 0,
    });
  };

  const handleRemoveQuestion = (questionId: string) => {
    setFormData(prev => ({
      ...prev,
      questions: prev.questions.filter(q => q.id !== questionId)
    }));
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'pending': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
      case 'approved': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
      case 'rejected': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
      case 'cancelled': return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
      default: return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
    }
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
          <p className="text-gray-600 dark:text-gray-400">Loading appointments...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
      <div className="max-w-7xl mx-auto p-6 space-y-8">
        {/* Header Section */}
        <div className="text-center space-y-4">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl shadow-lg shadow-purple-500/25">
            <Icon path={mdiCalendarClock} size={16} className="text-white" />
          </div>
          <div>
            <h1 className="text-4xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 dark:from-slate-200 dark:to-slate-400 bg-clip-text text-transparent">
              Appointment Management
            </h1>
            <p className="text-slate-600 dark:text-slate-400 mt-2 text-lg">
              Manage admin availability and student appointment requests
            </p>
          </div>
        </div>

        {/* Tabs */}
        <div className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm rounded-2xl p-1 shadow-xl shadow-slate-200/50 dark:shadow-slate-900/50 border border-slate-200/50 dark:border-slate-700/50">
          <div className="grid grid-cols-2 gap-1">
            <button
              onClick={() => setActiveTab('availability')}
              className={`py-3 px-4 rounded-xl font-medium transition-all duration-300 text-center ${
                activeTab === 'availability'
                  ? 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-lg shadow-purple-500/25'
                  : 'text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-white/50 dark:hover:bg-slate-700/50'
              }`}
            >
              Admin Availability
            </button>
            <button
              onClick={() => setActiveTab('schedule')}
              className={`py-3 px-4 rounded-xl font-medium transition-all duration-300 text-center ${
                activeTab === 'schedule'
                  ? 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-lg shadow-purple-500/25'
                  : 'text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:bg-white/50 dark:hover:bg-slate-700/50'
              }`}
            >
              Schedule View
            </button>
          </div>
        </div>

        {/* Availability Tab */}
        {activeTab === 'availability' && (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <div>
                <h2 className="text-2xl font-bold text-slate-800 dark:text-slate-200">Admin Availability Schedules</h2>
                <p className="text-slate-600 dark:text-slate-400 mt-1">Manage your available time slots for appointments</p>
              </div>
              <button
                onClick={() => setShowAvailabilityForm(true)}
                className="inline-flex items-center gap-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-xl font-medium shadow-lg shadow-purple-500/25 hover:shadow-xl hover:shadow-purple-500/30 transform hover:scale-105 transition-all duration-300"
              >
                <Icon path={mdiPlus} size={16} />
                Add Availability
              </button>
            </div>

          {/* Availability Form Modal */}
          {showAvailabilityForm && (
            <div className="fixed inset-0 bg-[rgba(0,0,0,0.6)] backdrop-blur-sm flex items-center justify-center z-110 p-4">
              <div className="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6 space-y-6">
                  <h3 className="text-2xl font-bold text-gray-900 dark:text-white">
                    {editingAvailability ? 'Edit Availability' : 'Add Availability'}
                  </h3>
                  
                  {/* Main content grid - left column for basic settings, right for questions */}
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* Left Column - Basic Settings */}
                    <div className="lg:col-span-2 space-y-4">
                      <div>
                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Date</label>
                        <DatePicker
                          selectedDate={formData.date}
                          onDateChange={(date) => setFormData({ ...formData, date })}
                          placeholder="Select appointment date"
                        />
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Start Time</label>
                          <input
                            type="time"
                            value={formData.startTime}
                            onChange={(e) => setFormData({ ...formData, startTime: e.target.value })}
                            className="w-full border dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">End Time</label>
                          <input
                            type="time"
                            value={formData.endTime}
                            onChange={(e) => setFormData({ ...formData, endTime: e.target.value })}
                            className="w-full border dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Slot Duration (minutes)</label>
                          <select
                            value={formData.slotDuration}
                            onChange={(e) => setFormData({ ...formData, slotDuration: parseInt(e.target.value) })}
                            className="w-full border dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                          >
                            <option value={15}>15 minutes</option>
                            <option value={30}>30 minutes</option>
                            <option value={45}>45 minutes</option>
                            <option value={60}>60 minutes</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">
                            Min. Prior Hours
                          </label>
                          <select
                            value={formData.minPriorHours}
                            onChange={(e) => setFormData({ ...formData, minPriorHours: parseInt(e.target.value) })}
                            className="w-full border dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                          >
                            <option value={0}>No restriction</option>
                            <option value={1}>1 hour</option>
                            <option value={2}>2 hours</option>
                            <option value={3}>3 hours</option>
                            <option value={6}>6 hours</option>
                            <option value={12}>12 hours</option>
                            <option value={24}>1 day</option>
                            <option value={48}>2 days</option>
                            <option value={72}>3 days</option>
                          </select>
                        </div>
                      </div>

                      <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h4 className="text-sm font-semibold text-gray-900 dark:text-white mb-3">Downtime/Break (Optional)</h4>
                        <p className="text-xs text-gray-500 dark:text-gray-400 mb-3">Set break times when unavailable</p>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Break Start</label>
                            <input
                              type="time"
                              value={formData.downtimeStart}
                              onChange={(e) => setFormData({ ...formData, downtimeStart: e.target.value })}
                              className="w-full border dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Break End</label>
                            <input
                              type="time"
                              value={formData.downtimeEnd}
                              onChange={(e) => setFormData({ ...formData, downtimeEnd: e.target.value })}
                              className="w-full border dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Right Column - Questions Section */}
                    <div className="lg:col-span-1">
                      <div className="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-700 rounded-xl p-5 h-full flex flex-col shadow-sm">
                        <div className="flex items-center justify-between mb-3">
                          <div>
                            <h4 className="text-sm font-semibold text-gray-900 dark:text-white">Questions (Optional)</h4>
                            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">Add questions students must answer when booking</p>
                          </div>
                          {formData.questions.length > 0 && (
                            <span className="text-xs bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-300 px-2 py-1 rounded-full font-medium">
                              {formData.questions.length} added
                            </span>
                          )}
                        </div>

                        {/* Existing Questions List */}
                        {formData.questions.length > 0 && (
                          <div className="mb-4 space-y-3 bg-white/70 dark:bg-gray-700/70 p-3 rounded-lg max-h-48 overflow-y-auto flex-1 border border-blue-100 dark:border-blue-800">
                            {formData.questions.map((question, index) => (
                              <div key={question.id} className="group flex items-start justify-between gap-3 p-3 bg-white dark:bg-gray-600 rounded-lg border border-gray-100 dark:border-gray-500 hover:shadow-md transition-all duration-200">
                                <div className="flex-1 min-w-0">
                                  <div className="flex items-start gap-2">
                                    <span className="flex-shrink-0 w-5 h-5 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center font-bold mt-0.5">
                                      {index + 1}
                                    </span>
                                    <div className="flex-1">
                                      <p className="text-sm font-medium text-gray-900 dark:text-white leading-relaxed break-words">
                                        {question.question}
                                      </p>
                                      <p className="text-xs text-gray-600 dark:text-gray-300 mt-1 flex items-center gap-1">
                                        <Icon path={mdiClockOutline} size={12} />
                                        Min: {question.minWordCount} word{question.minWordCount !== 1 ? 's' : ''}
                                      </p>
                                    </div>
                                  </div>
                                </div>
                                <button
                                  onClick={() => handleRemoveQuestion(question.id)}
                                  className="opacity-0 group-hover:opacity-100 p-1.5 hover:bg-red-100 dark:hover:bg-red-900 rounded-md transition-all duration-200 text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 flex-shrink-0"
                                  title="Remove question"
                                >
                                  <Icon path={mdiDelete} size={16} />
                                </button>
                              </div>
                            ))}
                          </div>
                        )}

                        {/* Add Question Form */}
                        <div className="space-y-3 border-t border-blue-200 dark:border-blue-700 pt-4 mt-auto">
                          <div className="space-y-3">
                            <div>
                              <label className="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Question Text
                              </label>
                              <textarea
                                value={newQuestion.question}
                                onChange={(e) => setNewQuestion({ ...newQuestion, question: e.target.value })}
                                placeholder="e.g., What is your main concern or goal for this appointment?"
                                className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                                rows={3}
                              />
                            </div>

                            <div>
                              <label className="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                Minimum Word Count
                              </label>
                              <input
                                type="number"
                                min="0"
                                max="1000"
                                value={newQuestion.minWordCount}
                                onChange={(e) => setNewQuestion({ ...newQuestion, minWordCount: Math.max(0, parseInt(e.target.value) || 0) })}
                                onWheel={(e) => { e.preventDefault(); (e.target as HTMLInputElement).blur(); }}
                                className="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                                placeholder="0 (optional)"
                              />
                            </div>
                          </div>

                          <button
                            onClick={handleAddQuestion}
                            disabled={!newQuestion.question.trim()}
                            className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2.5 rounded-lg hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-500 disabled:cursor-not-allowed text-sm font-medium shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center gap-2"
                          >
                            <Icon path={mdiPlus} size={16} />
                            Add Question
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Footer Buttons */}
                  <div className="flex gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button
                      onClick={handleSaveAvailability}
                      className="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-medium"
                    >
                      {editingAvailability ? 'Update' : 'Create'}
                    </button>
                    <button
                      onClick={cancelForm}
                      className="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 font-medium"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Availability List */}
          <div className="grid gap-4">
            {availabilities.length === 0 ? (
              <div className="text-center py-12 bg-white dark:bg-gray-800 rounded-lg">
                <Icon path={mdiCalendarClock} size={16} className="mx-auto text-gray-400 dark:text-gray-600 mb-3" />
                <p className="text-gray-600 dark:text-gray-400">No availability schedules yet</p>
                <p className="text-sm text-gray-500 dark:text-gray-500">Click "Add Availability" to create one</p>
              </div>
            ) : (
              availabilities.map(availability => (
                <div
                  key={availability.id}
                  className={`border dark:border-gray-700 rounded-lg p-4 ${
                    availability.isActive ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-900 opacity-60'
                  }`}
                >
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <h3 className="font-semibold text-lg text-gray-900 dark:text-white">Admin Meeting Time</h3>
                      <div className="mt-2 space-y-1 text-sm text-gray-600 dark:text-gray-400">
                        <p className="flex items-center gap-2">
                          <Icon path={mdiCalendar} size={16} />
                          {formatDateForDisplay(availability.date)}
                        </p>
                        <p className="flex items-center gap-2">
                          <Icon path={mdiClockOutline} size={16} />
                          {availability.startTime} - {availability.endTime}
                        </p>
                        <p>Slot Duration: {availability.slotDuration} minutes</p>
                        <p className="flex items-center gap-2">
                          <Icon path={mdiAlertCircle} size={16} />
                          Min. Prior Hours: {availability.minPriorHours || 0} hour{(availability.minPriorHours || 0) !== 1 ? 's' : ''}
                        </p>
                        {availability.downtimeStart && availability.downtimeEnd && (
                          <p className="flex items-center gap-2 text-amber-600 dark:text-amber-400 font-medium">
                            <Icon path={mdiClockOutline} size={16} />
                            Break: {availability.downtimeStart} - {availability.downtimeEnd}
                          </p>
                        )}
                        {availability.questions && availability.questions.length > 0 && (
                          <div className="mt-3 pt-2 border-t border-gray-200 dark:border-gray-700">
                            <p className="text-xs font-semibold text-blue-600 dark:text-blue-400 mb-2">
                              📋 {availability.questions.length} Question{availability.questions.length !== 1 ? 's' : ''}
                            </p>
                            <ul className="space-y-1">
                              {availability.questions.map((q, idx) => (
                                <li key={q.id} className="text-xs text-gray-600 dark:text-gray-400">
                                  {idx + 1}. {q.question.substring(0, 50)}{q.question.length > 50 ? '...' : ''}
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div className="flex gap-2 items-center">
                      <label className="relative inline-flex items-center cursor-pointer group">
                        <input
                          type="checkbox"
                          checked={availability.isActive}
                          onChange={() => handleToggleAvailability(availability)}
                          className="sr-only peer"
                        />
                        <div className={`w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600 transition-colors duration-200`}></div>
                        <span className={`ml-3 text-sm font-medium ${availability.isActive ? 'text-green-600 dark:text-green-400' : 'text-gray-600 dark:text-gray-400'}`}>
                          {availability.isActive ? 'Active' : 'Inactive'}
                        </span>
                      </label>
                      <button
                        onClick={() => startEditAvailability(availability)}
                        className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                        title="Edit"
                      >
                        <Icon path={mdiPencil} size={16} className="text-blue-600" />
                      </button>
                      <button
                        onClick={() => handleDeleteAvailability(availability.id)}
                        className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                        title="Delete"
                      >
                        <Icon path={mdiDelete} size={16} className="text-red-600" />
                      </button>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </div>
        )}

        {/* Schedule Tab */}
        {activeTab === 'schedule' && (
          <div className="space-y-6">
            <div>
              <h2 className="text-2xl font-bold text-slate-800 dark:text-slate-200">Appointment Schedule</h2>
              <p className="text-slate-600 dark:text-slate-400 mt-1">View and manage appointment slots across all dates</p>
            </div>

            <AppointmentScheduleGrid
              availabilities={availabilities.filter(a => a.isActive)}
              appointmentRequests={appointmentRequests}
              onApproveRequest={handleApproveRequest}
              onRejectRequest={handleRejectRequest}
              onDeleteRequest={handleDeleteRequest}
              onMarkAttendance={handleMarkAttendance}
              onEditMeeting={openEditMeetingModal}
            />
          </div>
        )}

        {/* Delete Confirmation Modal */}
        {showDeleteModal && requestToDelete && (
          <div className="fixed inset-0 bg-[rgba(0,0,0,0.6)] backdrop-blur-sm flex items-center justify-center z-110 p-4">
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center">
                  <Icon path={mdiDelete} size={24} className="text-red-600 dark:text-red-400" />
                </div>
                <div>
                  <h3 className="text-xl font-bold text-gray-900 dark:text-white">Delete Appointment Request</h3>
                  <p className="text-gray-600 dark:text-gray-400">This action cannot be undone</p>
                </div>
              </div>

              <div className="mb-6">
                <p className="text-gray-700 dark:text-gray-300 mb-4">
                  Are you sure you want to delete the appointment request from <strong>{requestToDelete.studentName}</strong>?
                </p>
                <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
                  <div className="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                    <p><strong>Date:</strong> {requestToDelete.appointmentDate}</p>
                    <p><strong>Time:</strong> {requestToDelete.appointmentTime}</p>
                  </div>
                </div>
              </div>

              <div className="flex gap-3">
                <button
                  onClick={cancelDeleteRequest}
                  className="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                >
                  Cancel
                </button>
                <button
                  onClick={confirmDeleteRequest}
                  className="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
                >
                  Delete Request
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Edit Meeting Time Modal */}
        {showEditMeetingModal && editingMeetingRequest && (
          <div className="fixed inset-0 bg-[rgba(0,0,0,0.6)] backdrop-blur-sm flex items-center justify-center z-110 p-4">
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-full flex items-center justify-center">
                  <Icon path={mdiPencil} size={24} className="text-blue-600 dark:text-blue-400" />
                </div>
                <div>
                  <h3 className="text-xl font-bold text-gray-900 dark:text-white">Edit Meeting Time</h3>
                  <p className="text-gray-600 dark:text-gray-400">{editingMeetingRequest.studentName}</p>
                </div>
              </div>

              <div className="space-y-4 mb-6">
                <div className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 mb-4">
                  <div className="text-sm text-gray-600 dark:text-gray-400 space-y-2">
                    <p><strong>Current Date:</strong> {editingMeetingRequest.appointmentDate}</p>
                    <p><strong>Current Time:</strong> {editingMeetingRequest.appointmentTime}</p>
                    <p><strong>Status:</strong> {editingMeetingRequest.status.toUpperCase()}</p>
                  </div>
                </div>

                {/* Step 1: Select Date */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                    Step 1: Select Date
                  </label>

                  {availableDaysForEdit.length === 0 ? (
                    <div className="text-center py-8 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-700">
                      <Icon path={mdiAlertCircle} size={24} className="mx-auto text-yellow-600 dark:text-yellow-400 mb-2" />
                      <p className="text-sm text-yellow-700 dark:text-yellow-300">No available dates found</p>
                    </div>
                  ) : (
                    <div className="max-h-40 overflow-y-auto space-y-2 bg-gray-50 dark:bg-gray-700/30 rounded-lg p-3 border border-gray-200 dark:border-gray-600">
                      {availableDaysForEdit.map((date) => {
                        // Convert date string to dd-mm-yyyy format
                        const dateParts = date.split('-');
                        const formattedDate = dateParts.length === 3 
                          ? `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}` 
                          : date;
                        
                        return (
                          <button
                            key={date}
                            onClick={() => handleSelectDateForEdit(date)}
                            className={`w-full p-3 rounded-lg text-left transition-colors border ${
                              editMeetingDate === date
                                ? 'bg-blue-100 dark:bg-blue-900/30 border-blue-500 dark:border-blue-400'
                                : 'bg-white dark:bg-gray-600 border-gray-200 dark:border-gray-500 hover:bg-blue-50 dark:hover:bg-blue-900/20'
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <p className="font-medium text-gray-900 dark:text-white">{formattedDate}</p>
                              {editMeetingDate === date && (
                                <Icon path={mdiCheck} size={20} className="text-blue-600 dark:text-blue-400" />
                              )}
                            </div>
                          </button>
                        );
                      })}
                    </div>
                  )}
                </div>

                {/* Step 2: Select Time */}
                {editMeetingDate && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                      Step 2: Select Time
                    </label>

                    {availableSlotsForEdit.length === 0 ? (
                      <div className="text-center py-6 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-700">
                        <Icon path={mdiAlertCircle} size={20} className="mx-auto text-yellow-600 dark:text-yellow-400 mb-2" />
                        <p className="text-sm text-yellow-700 dark:text-yellow-300">No time slots available for this date</p>
                      </div>
                    ) : (
                      <div className="max-h-60 overflow-y-auto bg-gray-50 dark:bg-gray-700/30 rounded-lg p-3 border border-gray-200 dark:border-gray-600">
                        <div className="grid grid-cols-2 gap-2">
                          {availableSlotsForEdit.map((slot, index) => (
                            <button
                              key={index}
                              onClick={() => setEditMeetingTime(slot.time)}
                              className={`p-3 rounded-lg text-center transition-colors border ${
                                editMeetingTime === slot.time
                                  ? 'bg-blue-100 dark:bg-blue-900/30 border-blue-500 dark:border-blue-400'
                                  : 'bg-white dark:bg-gray-600 border-gray-200 dark:border-gray-500 hover:bg-blue-50 dark:hover:bg-blue-900/20'
                              }`}
                            >
                              <div className="flex items-center justify-center gap-2">
                                <p className="font-medium text-gray-900 dark:text-white">{slot.time}</p>
                                {editMeetingTime === slot.time && (
                                  <Icon path={mdiCheck} size={16} className="text-blue-600 dark:text-blue-400" />
                                )}
                              </div>
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              <div className="flex gap-3">
                <button
                  onClick={closeEditMeetingModal}
                  className="flex-1 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                >
                  Cancel
                </button>
                <button
                  onClick={handleUpdateMeetingTime}
                  disabled={!editMeetingDate || !editMeetingTime}
                  className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed"
                >
                  <Icon path={mdiCheck} size={16} />
                  Update
                </button>
              </div>
            </div>
          </div>
        )}

      </div>
    </div>
  );
};

export default AppointmentsManagementPage;
